#include "mruby_<%= module_name %>.h"

/* MRUBY_BINDING: header */
/* MRUBY_BINDING_END */

#ifdef __cplusplus
extern "C" {
#endif

<% module_functions.each do |function| -%>
/* MRUBY_BINDING: <%= function['name'] %> */
#if BIND_<%= function['name'] %>_FUNCTION
#define <%= function['name'] %>_REQUIRED_ARGC <%= function['in_params'].length %>
#define <%= function['name'] %>_OPTIONAL_ARGC 0
/* <%= function['name'] %>
 *
 * Parameters:<%= " None" unless function['in_params'].any? %>
<% if function['in_params'].any? -%>
<%   function['in_params'].each do |param| -%>
 * - <%= param['name'] %>: <%= param['type']['type_name'] %>
<%   end -%>
<% end -%>
 * Return Type: <%= function['return_type']['type_name'] %>
 */
mrb_value
mrb_<%= module_name %>_<%= function['name'] %>(mrb_state* mrb, mrb_value self) {
<%
     to_unbox = function['in_params'].select { |p| p['ctype'].needs_unboxing? }
     to_type_check = function['in_params'].select { |p| p['ctype'].needs_type_check? }
     to_cleanup_unboxing = function['in_params'].select { |p| p['ctype'].needs_unboxing_cleanup? }
-%>
<% if function['out_count'] > 1 -%>
  mrb_value results = mrb_ary_new(mrb);
<% end -%>
<%   if function['params'].any? -%>
<%     function['params'].each do |param| -%>
<%       type = param['ctype'] -%>
<%       type.recv(param['name']).each_line do |line| -%>
  <%= line.sub("\n", '') %>
<%     end -%>
<%   end -%>

<%   unless function['in_params'].empty? -%>
  /* Fetch the args */
<%   format_specifiers = function['in_params'].map { |p| p['ctype'].format_specifier }.join('') -%>
<%   get_args_argv =  function['in_params'].map { |p| p['ctype'].get_args_argv(p['name']) }.flatten.join(', ') -%>
  mrb_get_args(mrb, "<%= format_specifiers %>", <%= get_args_argv %>);
<%   end -%>

<%     if to_type_check.any? -%>
  /* Type checking */
<%       to_type_check.each do |param| -%>
<%         (param['ctype'].type_check(param['name'])).each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%         end -%>
<%       end -%>

<%     end -%>
<%     if to_unbox.any? -%>
<%       to_unbox.each do |param| -%>
  /* Unbox param: <%= param['name'] %> */
<%         param['ctype'].unbox(param['name']).each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%         end -%>

<%       end -%>
<%     end -%>
<%   end -%>
  /* Invocation */
<% 
     argv = function['params'].map { |p| p['ctype'].invocation_argv(p['name']) }.flatten.join(', ')
-%>
  <%= function['return_type']['type_name'] == 'void' ? '' : "#{function['return_type']['type_name']} native_return_value = "  %><%= function['name'] %>(<%= argv %>);

<%   if function['return_type']['type_name'] != 'void' -%>
  /* Box the return value */
<%     (function['ctype'].box_return('native_return_value', 'return_value')).each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%     end -%>
<%     if function['ctype'].needs_boxing_cleanup? -%>
<%       function['ctype'].cleanup_return('native_return_value').each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%       end -%>
<%     end -%>
<%     if function['out_count'] > 1 -%>
  mrb_ary_push(mrb, results, return_value);
<%     end -%>
  
<%   end -%>
<%   if function['out_params'].any? -%>
<%     function['out_params'].each do |out| -%>
  /* Box out param: <%= out['name'] %> */
<%       out['ctype'].box(out['name']).each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%       end -%>
<%       if out['ctype'].needs_boxing_cleanup? -%>
  /* Clean out param: <%= out['name'] %> */
<%         out['ctype'].cleanup_out_param(out['name']).each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%         end -%>
<%       end -%>
<%     end -%>

<%   end -%>
<%   if function['out_count'] > 1 && function['out_params'].any? -%>
  /* Add out params to results */
<%     function['out_params'].each do |out| -%>
  mrb_ary_push(mrb, results, <%= "#{out['name']}" %>);
<%     end -%>

<%   end -%>
<%   if to_cleanup_unboxing.any? -%>
<%     to_cleanup_unboxing.each do |param| -%>
  /* Clean in param: <%= param['name'] %> */
<%       param['ctype'].cleanup_unboxing(param['name']).each_line do |line| -%>
  <%= line.sub("\n", "") %>
<%       end -%>

<%     end -%>
<%   end -%>
<%   if function['out_count'] == 0 -%>
  return mrb_nil_value();
<%   elsif function['out_count'] == 1 && !function['is_void'] -%>
  return return_value;
<%   elsif function['out_count'] == 1 && function['is_void'] -%>
  return <%= function['out_params'].first['name'] %>;
<%   else -%>
  return results;
<%   end -%>
}
#endif
/* MRUBY_BINDING_END */

<% end -%>

void mrb_<%= gem_name.gsub('-', '_') %>_gem_init(mrb_state* mrb) {
/* MRUBY_BINDING: pre_module_definition */
/* MRUBY_BINDING_END */
  
  struct RClass* <%= module_name %>_module = mrb_define_module(mrb, "<%= module_name%>");
  mruby_<%= module_name %>_define_macro_constants(mrb);

/* MRUBY_BINDING: pre_class_initializations */
/* MRUBY_BINDING_END */

/* MRUBY_BINDING: class_initializations */
<% classes.each do |klass| -%>
#if BIND_<%= klass['ruby_name'] %>_TYPE
  mrb_<%= module_name %>_<%= klass['ruby_name'] %>_init(mrb);
#endif
<% end -%>
/* MRUBY_BINDING_END */

/* MRUBY_BINDING: pre_global_function_initializations */
/* MRUBY_BINDING_END */

/* MRUBY_BINDING: global_function_definitions */
  /*
   * Global Functions
   */
<% module_functions.each do |function| -%>
#if BIND_<%= function['name'] %>_FUNCTION
  mrb_define_class_method(mrb, <%= module_name %>_module, "<%= function['name'] %>", mrb_<%= module_name %>_<%= function['name'] %>, MRB_ARGS_ARG(<%= function['name'] %>_REQUIRED_ARGC, <%= function['name'] %>_OPTIONAL_ARGC));
#endif
<% end -%>
/* MRUBY_BINDING_END */

/* MRUBY_BINDING: post_module_definition */
/* MRUBY_BINDING_END */
}

void mrb_<%= gem_name.gsub('-', '_') %>_gem_final(mrb_state* mrb){
/* MRUBY_BINDING: module_final */
/* MRUBY_BINDING_END */
}

/* MRUBY_BINDING: footer */
/* MRUBY_BINDING_END */

#ifdef __cplusplus
}
#endif
